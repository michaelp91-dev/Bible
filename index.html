import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { Search, Globe, ChevronRight, ChevronLeft, ArrowLeft, PlusCircle, History, Loader2, BookOpen } from 'lucide-react';

const getSubscript = (num) => {
  const map = { "0": "₀", "1": "₁", "2": "₂", "3": "₃", "4": "₄", "5": "₅", "6": "₆", "7": "₇", "8": "₈", "9": "₉" };
  return String(num).split('').map(c => map[c] || c).join('');
};

export default function App() {
  const [view, setView] = useState('reading'); 
  const [version, setVersion] = useState('KJV'); 
  const [currentBook, setCurrentBook] = useState(null);
  const [currentChapter, setCurrentChapter] = useState(1);
  const [navStep, setNavStep] = useState('books'); 
  const [inspectVerse, setInspectVerse] = useState(null);
  const [notes, setNotes] = useState([]);
  const [newNote, setNewNote] = useState('');
  
  const [booksData, setBooksData] = useState([]);
  const [bibleData, setBibleData] = useState({ KJV: {}, VUL: {} });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // --- Data Loading & Dynamic Book Generation ---
  useEffect(() => {
    const loadFiles = async () => {
      try {
        setLoading(true);
        // We pull from KJV.txt for full names and vuldat.txt for Latin comparison
        const [kjvRes, vulRes] = await Promise.all([
          fetch('KJV.txt'),
          fetch('vuldat.txt')
        ]);

        if (!kjvRes.ok || !vulRes.ok) throw new Error("Could not find bible data files (KJV.txt and vuldat.txt).");

        const [kjvText, vulText] = await Promise.all([kjvRes.text(), vulRes.text()]);

        const kjvMap = {};
        const vulMap = {};
        const bookList = [];
        const bookAbbrMap = {}; // Maps full name to Latin abbreviation based on order

        // 1. Parse KJV.txt (Format: "Book Chapter:Verse\tText")
        // Regex to match "Book Name Chapter:Verse"
        const kjvRegex = /^(.+)\s(\d+):(\d+)\t(.+)$/;
        
        kjvText.split(/\r?\n/).forEach(line => {
          const match = line.match(kjvRegex);
          if (match) {
            const [_, bookName, chapter, verse, text] = match;
            const cNum = parseInt(chapter);
            const vNum = parseInt(verse);

            if (!kjvMap[bookName]) {
              kjvMap[bookName] = {};
              bookList.push({ name: bookName, chapters: 0 });
            }
            if (!kjvMap[bookName][cNum]) kjvMap[bookName][cNum] = [];
            
            kjvMap[bookName][cNum].push({ num: vNum, text: text.trim() });
            
            // Track max chapter
            const bookObj = bookList.find(b => b.name === bookName);
            if (cNum > bookObj.chapters) bookObj.chapters = cNum;
          }
        });

        // 2. Parse vuldat.txt (Format: "Abbr|C|V|Text~")
        const latinBookOrder = [];
        vulText.split(/\r?\n/).forEach(line => {
          const parts = line.split('|');
          if (parts.length >= 4) {
            const abbr = parts[0], c = parts[1], v = parts[2], t = parts[3].replace('~', '').trim();
            if (!vulMap[abbr]) {
              vulMap[abbr] = {};
              latinBookOrder.push(abbr);
            }
            if (!vulMap[abbr][c]) vulMap[abbr][c] = [];
            vulMap[abbr][c].push({ num: parseInt(v), text: t });
          }
        });

        // 3. Link Full Names to Latin Abbrs based on file sequence
        // We assume the sequence of books in KJV.txt matches vuldat.txt
        const generatedBooks = bookList.map((book, index) => {
          const latinAbbr = latinBookOrder[index];
          bookAbbrMap[book.name] = latinAbbr;
          return {
            ...book,
            abbr: latinAbbr // Store the abbreviation for Latin lookup
          };
        });

        setBooksData(generatedBooks);
        setBibleData({ KJV: kjvMap, VUL: vulMap });
        
        if (generatedBooks.length > 0) {
          setCurrentBook(generatedBooks[0]);
        }
        
        setLoading(false);
      } catch (err) {
        setError(err.message);
        setLoading(false);
      }
    };
    loadFiles();
  }, []);

  // --- Derived State ---
  const chapterVerses = useMemo(() => {
    if (!currentBook) return [];
    const kjv = bibleData.KJV[currentBook.name]?.[currentChapter] || [];
    const vul = bibleData.VUL[currentBook.abbr]?.[currentChapter] || [];
    
    return kjv.map((v, i) => ({
      num: v.num,
      text: v.text,
      lat: vul[i]?.text || "[Latin not found]"
    }));
  }, [bibleData, currentBook, currentChapter]);

  // --- Handlers ---
  const handleAddNote = () => {
    if (!newNote.trim() || !currentBook) return;
    setNotes([{
      id: Date.now(),
      verse: `${currentBook.name} ${currentChapter}:${inspectVerse}`,
      content: newNote,
      timestamp: new Date().toLocaleTimeString()
    }, ...notes]);
    setNewNote('');
    setView('reading');
  };

  const changeChapter = (delta) => {
    if (!currentBook) return;
    const next = currentChapter + delta;
    if (next >= 1 && next <= currentBook.chapters) {
      setCurrentChapter(next);
      window.scrollTo(0, 0);
    }
  };

  if (loading) return (
    <div className="h-screen flex flex-col items-center justify-center bg-white">
      <Loader2 className="animate-spin text-blue-600 mb-4" size={48} />
      <p className="text-neutral-500 animate-pulse font-medium tracking-tight">Extracting names from Bible texts...</p>
    </div>
  );

  if (error || !currentBook) return (
    <div className="h-screen flex flex-col items-center justify-center p-10 text-center">
      <div className="bg-red-50 text-red-600 p-6 rounded-2xl border border-red-100 max-w-sm">
        <h2 className="font-bold text-lg mb-2">Resource Error</h2>
        <p className="text-sm">{error || "No book data found."}</p>
        <p className="text-xs mt-4 text-red-400 italic">Ensure KJV.txt and vuldat.txt are in the same folder.</p>
      </div>
    </div>
  );

  return (
    <div className="flex flex-col h-screen bg-neutral-50 text-neutral-900 font-sans max-w-2xl mx-auto border-x shadow-xl overflow-hidden">
      
      {/* HEADER */}
      <div className="bg-white border-b px-4 py-3 flex items-center justify-between sticky top-0 z-20 shadow-sm">
        <button 
          onClick={() => setVersion(v => v === 'KJV' ? 'VUL' : 'KJV')}
          className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100"
        >
          <Globe size={14} /> {version}
        </button>

        <button 
          onClick={() => { setView('navigation'); setNavStep('books'); }}
          className="flex items-center gap-1 text-base font-black hover:bg-neutral-100 px-3 py-1 rounded-lg transition-colors truncate"
        >
          {currentBook.name} {currentChapter}
          <ChevronRight size={16} className="text-neutral-300" />
        </button>

        <div className="flex gap-1">
          <button onClick={() => setView('notes')} className="p-2 rounded-full hover:bg-neutral-100 text-neutral-500">
            <History size={20} />
          </button>
        </div>
      </div>

      {/* BODY */}
      <div className="flex-1 overflow-y-auto p-6 scroll-smooth">
        
        {view === 'reading' && (
          <div className="max-w-prose mx-auto">
            <div className="text-center mb-10">
              <span className="text-xs font-bold text-blue-500 uppercase tracking-widest block mb-1">
                {version === 'KJV' ? 'King James Version' : 'Latin Vulgate'}
              </span>
              <h1 className="text-4xl font-serif font-black">{currentBook.name} {currentChapter}</h1>
            </div>

            <div className="text-xl leading-relaxed text-neutral-800 font-serif">
              {chapterVerses.map(v => (
                <span 
                  key={v.num} 
                  onClick={() => { setInspectVerse(v.num); setView('inspect'); }}
                  className="cursor-pointer hover:bg-blue-50 transition-colors rounded px-0.5 inline"
                >
                  <span className="text-blue-500 font-bold text-xs align-sub mr-1 select-none">
                    {getSubscript(v.num)}
                  </span>
                  {version === 'KJV' ? v.text : v.lat}{' '}
                </span>
              ))}
            </div>

            <div className="mt-16 pt-8 border-t flex justify-between gap-4">
              <button 
                disabled={currentChapter === 1}
                onClick={() => changeChapter(-1)}
                className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border font-bold disabled:opacity-20 hover:bg-white transition-all active:scale-95"
              >
                <ChevronLeft size={20} /> Previous
              </button>
              <button 
                disabled={currentChapter === currentBook.chapters}
                onClick={() => changeChapter(1)}
                className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border font-bold disabled:opacity-20 hover:bg-white transition-all active:scale-95"
              >
                Next <ChevronRight size={20} />
              </button>
            </div>
          </div>
        )}

        {view === 'navigation' && (
          <div className="animate-in fade-in slide-in-from-bottom-2 duration-300">
            <div className="flex items-center gap-3 mb-6">
              <button onClick={() => setView('reading')} className="p-2 hover:bg-neutral-100 rounded-full">
                <ArrowLeft size={20} />
              </button>
              <h2 className="text-xl font-bold">{navStep === 'books' ? 'Select Book' : currentBook.name}</h2>
            </div>

            {navStep === 'books' ? (
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {booksData.map(b => (
                  <button 
                    key={b.name}
                    onClick={() => { setCurrentBook(b); setNavStep('chapters'); }}
                    className={`p-4 text-left rounded-xl border transition-all ${currentBook.name === b.name ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white hover:border-blue-400'}`}
                  >
                    <div className="font-bold text-sm">{b.name}</div>
                    <div className={`text-[10px] uppercase font-bold ${currentBook.name === b.name ? 'text-blue-200' : 'text-neutral-400'}`}>
                      {b.chapters} Chapters
                    </div>
                  </button>
                ))}
              </div>
            ) : (
              <div className="grid grid-cols-5 gap-2">
                {Array.from({ length: currentBook.chapters }, (_, i) => i + 1).map(c => (
                  <button 
                    key={c}
                    onClick={() => { setCurrentChapter(c); setView('reading'); }}
                    className={`aspect-square flex items-center justify-center rounded-xl border font-bold ${currentChapter === c ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:border-blue-400'}`}
                  >
                    {c}
                  </button>
                ))}
              </div>
            )}
          </div>
        )}

        {view === 'inspect' && inspectVerse && (
          <div className="space-y-6 animate-in slide-in-from-right-2 duration-300">
            <button onClick={() => setView('reading')} className="flex items-center gap-2 text-blue-600 font-bold">
              <ArrowLeft size={18} /> Back to Reading
            </button>
            
            <div className="bg-white p-6 rounded-3xl border shadow-sm space-y-6">
              <div>
                <span className="text-[10px] font-black uppercase text-neutral-400 tracking-tighter">King James English</span>
                <p className="text-xl font-serif mt-1">{chapterVerses[inspectVerse-1]?.text}</p>
              </div>
              <div className="pt-6 border-t">
                <span className="text-[10px] font-black uppercase text-blue-500 tracking-tighter">Latin Vulgate</span>
                <p className="text-xl font-serif text-blue-900 mt-1">{chapterVerses[inspectVerse-1]?.lat}</p>
              </div>
            </div>

            <div className="bg-white p-6 rounded-3xl border shadow-sm">
              <h3 className="font-bold text-neutral-700 flex items-center gap-2 mb-4">
                <PlusCircle size={18} className="text-blue-500" /> Verse Study Note
              </h3>
              <textarea 
                className="w-full p-4 border rounded-2xl bg-neutral-50 focus:ring-2 focus:ring-blue-500 outline-none h-32"
                placeholder="Write your notes here..."
                value={newNote}
                onChange={(e) => setNewNote(e.target.value)}
              />
              <button 
                onClick={handleAddNote}
                className="mt-4 w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all"
              >
                Save Note
              </button>
            </div>
          </div>
        )}

        {view === 'notes' && (
          <div className="space-y-4 animate-in fade-in duration-300">
            <div className="flex items-center gap-3 mb-6">
              <button onClick={() => setView('reading')} className="p-2 hover:bg-neutral-100 rounded-full">
                <ArrowLeft size={20} />
              </button>
              <h2 className="text-xl font-bold">Recent Notes</h2>
            </div>

            {notes.length === 0 ? (
              <div className="text-center py-20 opacity-30">
                <BookOpen size={64} className="mx-auto mb-4" />
                <p className="font-bold">No notes yet</p>
              </div>
            ) : (
              notes.map(n => (
                <div key={n.id} className="bg-white p-5 rounded-2xl border shadow-sm">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-[10px] font-black bg-blue-50 text-blue-600 px-2 py-1 rounded-md">{n.verse}</span>
                    <span className="text-[10px] text-neutral-400 font-bold">{n.timestamp}</span>
                  </div>
                  <p className="text-neutral-700 leading-relaxed">{n.content}</p>
                </div>
              ))
            )}
          </div>
        )}

      </div>

      <div className="bg-white border-t p-4 text-[10px] font-bold uppercase tracking-widest text-neutral-400 flex justify-between">
        <span>Dynamic Biblical Database</span>
        <span className="text-green-500">Live</span>
      </div>
    </div>
  );
}
